<html>
<head>
  <meta charset="utf-8">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/vis-network/9.1.2/dist/dist/vis-network.min.css"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/vis-network/9.1.2/dist/vis-network.min.js"></script>
  <title>Hit Browser</title>
  <link rel="stylesheet" href="./styles.css"/>
</head>

<body>
  <div class="card" style="width: 100%">
    <div id="mynetwork" class="card-body"></div>
  </div>

  <div id="loadingBar">
    <div id="outerBorder">
      <div id="text">0%</div>
      <div id="border">
        <div id="bar"></div>
      </div>
    </div>
  </div>

  <script type="text/javascript">

    // initialize global variables.
    var edges;
    var nodes;
    var allNodes;
    var allEdges;
    var nodeColors;
    var originalNodes;
    var network;
    var container;
    var options, data;
    var filter = {
      item : '',
      property : '',
      value : []
    };

    // This method is responsible for drawing the graph, returns the drawn network
    function drawGraph() {
      var container = document.getElementById('mynetwork');


      // parsing and collecting nodes and edges from the python
      nodes = new vis.DataSet({{nodes|tojson}});
      edges = new vis.DataSet({{edges|tojson}});

      nodeColors = {};
      allNodes = nodes.get({ returnType: "Object" });
      for (nodeId in allNodes) {
        nodeColors[nodeId] = allNodes[nodeId].color;
      }
      allEdges = edges.get({ returnType: "Object" });
      // adding nodes and edges to the graph
      data = {nodes: nodes, edges: edges};

      var options = {{options|safe}};
      console.log(options)
      // console.log(options.Heading.root_path)
      // var root_path = options.heading.root_path;
      // delete options.heading;

      // Create the network.
      network = new vis.Network(container, data, options);

      // Stabalize the network.
      network.stabilize(2000);
      network.on("stabilizationProgress", function(params) {
        document.getElementById('loadingBar').removeAttribute("style");
        var maxWidth = 496;
        var minWidth = 20;
        var widthFactor = params.iterations/params.total;
        var width = Math.max(minWidth,maxWidth * widthFactor);
        document.getElementById('bar').style.width = width + 'px';
        document.getElementById('text').innerHTML = Math.round(widthFactor*100) + '%';
      });
      network.once("stabilizationIterationsDone", function() {
        document.getElementById('text').innerHTML = '100%';
        document.getElementById('bar').style.width = '496px';
        document.getElementById('loadingBar').style.opacity = 0;
        setTimeout(function () {
          document.getElementById('loadingBar').style.display = 'none';
        }, 500);
      });

      // Click a hit.
      network.on( 'click', function(properties) {
        var ids = properties.nodes;
        var clickedNodes = nodes.get(ids);
        clickedNodes.forEach((n) => {
          // var file_path = root_path + n['path'];
          var file_path = n['path'];
          // var file_path = n['path'];
          // console.log(file_path);
          var audio = new Audio(file_path);
          audio.play();
        })
      });

      // Set min and max zoom.
      network.on("zoom", function() {
        if (network.getScale() < 0.10) {
          network.moveTo({scale: 0.10});
        } else if (network.getScale() > 1) {
          network.moveTo({scale: 1});
        }
      });

      return network;
    }
    drawGraph();
  </script>
</body>
</html>